<div dir="rtl">

# Internationalization Setup

هذا المشروع يستخدم مكتبة **next-intl** لضبط الترجمة في تطبيق Next.js (App Router). فيما يلي شرح تفصيلي للملفات وكيفية ترابطها:

---

## نظرة عامة على سير العمل

1. **المستخدم يزور أي صفحة** → `app/layout.tsx` يقرأ `locale` الحالي عبر `getLocale()` التي تعتمد على `next-intl` والكوكي `locale`.
2. **`next-intl plugin`** يوجّه الطلب إلى `src/i18n/request.ts` ليحمّل ملفات الرسائل لكل Namespace.
3. **`NextIntlClientProvider`** في `app/layout.tsx` يزوّد كل Client Component بالدوال `useTranslations` و `useLocale`.
4. **المكوّنات/الصفحات** تستخدم `getTranslations` (لـ Server Components) أو `useTranslations` (لـ Client Components) بحسب namespace المطلوب.
5. **تغيير اللغة** يتم عبر `setLocaleAction` (Server Action) + `LocaleSwitcher`، حيث تُحدَّث الكوكي ثم يُعاد `refresh` للصفحة.

> المسار الحالي لا يُظهر اللغة في الـ URL، بل يعتمد على الكوكي `locale`. إذا أردت مسارات مثل `/en/...` فيلزم إضافة segment `[locale]` داخل `app/` وتهيئة `next-intl` accordingly (مذكور في قسم لاحق).

---

## 1. المسارات وملفات الرسائل

- حاليًا هناك مجلدات مثل `src/messages/en/landing.json`, `src/messages/ar/landing.json`, `src/messages/fr/...`.  
  يمكنك بسهولة توسيع هذا إلى بنية مجلدات كما يلي:

  ```
  src/messages/
    en/
      landing.json
      sidebar.json
      dashboard.json
    ar/
      landing.json
      sidebar.json
      dashboard.json
    fr/
      landing.json
      ...
  ```

  ثم داخل `src/i18n/request.ts` تجمع هذه الملفات لكل لغة:

  ```ts
  const landing = (await import(`../messages/${locale}/landing.json`)).default;
  const sidebar = (await import(`../messages/${locale}/sidebar.json`)).default;
  return {
    locale,
    messages: { landing, sidebar, common }
  };
  ```

  لاحقًا تستدعي `useTranslations("landing")` أو `useTranslations("sidebar")` (أو أي namespace آخر) داخل كل مكوّن. هذا يطابق نمط الـ Namespaces المعروف في i18n.

---

## 2. ضبط next-intl (config & plugin)

- `src/i18n/locales.ts`:  
  يعرّف قائمة اللغات المدعومة `locales` ونطاق `Locale` بالإضافة إلى `defaultLocale`.
- **أين يُستخدم؟** يتم استيراده في `request.ts`, `actions.ts`, وأي ملف يحتاج للتحقق من أن رمز اللغة ضمن القائمة المعتمدة.

- `src/i18n/request.ts`:  
  الملف الذي يطلبه plugin `next-intl` لجلب الإعدادات الخاصة بكل طلب. يقرأ اللغة من كوكي `locale` أو من Header `accept-language`, ثم يرجع `locale` وملف الرسائل المناسب.
- **أين يُستخدم؟** يمر به كل طلب تلقائيًا عبر `createNextIntlPlugin`، ونتيجته تُستهلك داخل `app/layout.tsx` عبر `getMessages`.

- `next.config.ts`:  
  تم استخدام `createNextIntlPlugin("./src/i18n/request.ts")` بحيث يحقن Next.js إعدادات الترجمة تلقائياً على مستوى الـ build و dev server. هذا ما ينصح به الدليل الرسمي لـ next-intl.
- **أين يُستخدم؟** يتم تحميله من Next أثناء تشغيل dev server أو build، ولا يحتاج لاستيراد يدوي داخل الكود.

---

## 3. المزود العام (App Layout)

- `src/app/layout.tsx`:  
  - يجلب اللغة الحالية عبر `getLocale()` وملف الرسائل عبر `getMessages()` (من `next-intl/server`).  
  - يلف التطبيق بـ `NextIntlClientProvider` حتى تقدر Client Components تستخدم `useTranslations`.  
  - يحافظ على مزوّدات الثيم والسايدبار الموجودة مسبقاً.

> أي خطأ في تحميل الرسائل (مثلاً لو locale غير مدعوم) سيؤدي إلى `notFound()` لضمان سلوك واضح.

---

## 4. تغيير اللغة (Server Action + Client)

- `src/i18n/actions.ts`:  
  يحوي Server Action `setLocaleAction` الذي يحدّث كوكي `locale`, مع صلاحية سنة. يستخدمه العملاء لتغيير اللغة، ثم يتم `router.refresh()` من جانب العميل.
- **أين يُستخدم؟** يتم استيراده داخل `LocaleSwitcher` (أو أي مكوّن آخر) لاستدعاء `setLocaleAction` عند اختيار لغة جديدة.

- `src/components/common/LocaleSwitcher.tsx`:  
  - يستدعي `useLocale()` ليتعرف على اللغة الحالية.  
  - يعرض أزرار اللغات المتاحة (EN/AR/FR).  
  - عند الضغط يرسل `setLocaleAction` ويعمل refresh للصفحة عشان تتطبق الرسائل الجديدة.

---

## 5. استخدام الترجمة في الصفحات والمكوّنات

- Server Components (مثال: `src/app/(marketing)/page.tsx`):  
  تستخدم `getTranslations("landing")` لجلب النصوص بشكل async.

- Client Components (مثال: `AppSidebar`, `LocaleSwitcher`):  
  تستخدم `useTranslations("sidebar")` للحصول على النصوص ضمن المزود.

> يمكن استخدام Namespaces متعددة، المهم أن نفس المفتاح موجود في ملف الرسائل لكل لغة.

---

## 6. أسئلة شائعة

- **هل اللغة تظهر في URL؟**  
  لا، النظام الحالي يعتمد على كوكيز + Headers، وبالتالي المسارات تبقى نظيفة (`/profile`). هذا لا يؤثر على SEO طالما لديك نسخة واحدة من الصفحة لكل URL.
  - لو أردت لغة في الرابط، تحتاج إنشاء مجلد `app/[locale]/...` وتعريف `generateStaticParams` أو `middleware` لضبط اللغة. هذا يعني أن كل صفحة ستعيش داخل هذا المجلد، وستحتاج لتحديث جميع الروابط لتشمل `/en`, `/ar`, ... إلخ. `next-intl` يدعم هذا السيناريو بالكامل لكن يتطلب قرارًا معماريًا مبكرًا.

- **هل يمكن لاحقاً التحويل إلى مسارات مثل `/en/...`؟**  
  نعم. ستحتاج لإضافة segment `[locale]` وتحديث البنية حسب الوثائق، لكن معظم البنية الحالية (الرسائل، المزود، Server Actions) قابلة لإعادة الاستخدام.

---

## 7. مراجع

- دليل next-intl الرسمي لإعداد App Router:  
  https://next-intl.dev/docs/getting-started/app-router

---

## 8. إضافة لغة ثالثة (مثلاً الفرنسية)

- لإضافة لغة جديدة مثل الفرنسية:
  1. أضف رمز اللغة إلى `src/i18n/locales.ts`:
     ```ts
     export const locales = ["en", "ar", "fr"] as const;
     ```
  2. أنشئ مجلد `messages/fr` واملأه بملفات JSON لنفس الـ namespaces الموجودة في اللغات الأخرى.
  3. تأكد من أن `request.ts` يحمل الرسائل بناءً على `locale`، ولن تحتاج لأي تغيير آخر لأن `next-intl` سيقرأ اللغة تلقائيًا من الكوكي أو header.
  4. أضف اللغة إلى `LocaleSwitcher` (مثلاً زر FR) وسيصبح المستخدم قادرًا على اختيار الفرنسية فورًا.

---

بهذا الترتيب، كل أجزاء الترجمة (الرسائل، الكشف عن اللغة، المزود، مبدل اللغة) تعمل في تناغم وتدعم كلا من Server/Client Components بسهولة.

</div>